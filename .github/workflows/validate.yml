name: Validate Final Submission

on:
  pull_request_target:
    branches:
      - '**'

jobs:
  validate-submission:
    name: Validate PR
    runs-on: ubuntu-latest
    environment: production  # Required to access WINNER_LOCKED




    steps:
      - name: üì• Check out PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

#      - name: üîê Load validation hashes
#        run: |
#          mkdir -p scripts
#          echo "${{ secrets.HASHES_JSON }}" | base64 -d > scripts/hashes.json

      - name: üß™ Install Python dependencies
        run: pip install beautifulsoup4 lxml

      - name: ‚úÖ Check Submission Lockout
        continue-on-error: true
        run: |
          if [ "${{ vars.WINNER_LOCKED }}" == "true" ]; then
            echo "‚ùå A winner has already been declared. Submissions are closed."
            echo "check-lockout FAIL" >> result.log
          else
            echo "‚úÖ Submission window is open."
          fi

      - name: ‚úÖ Check PR Target Branch
        continue-on-error: true
        run: python3 scripts/validate.py check-branch || echo "check-branch FAIL" >> result.log

      - name: ‚úÖ Check PR Secret Phrase
        continue-on-error: true
        run: python3 scripts/validate.py check-pr-message || echo "check-pr-message FAIL" >> result.log

      - name: ‚úÖ Check Background Color
        continue-on-error: true
        run: python3 scripts/validate.py check-background || echo "check-background FAIL" >> result.log

      - name: ‚úÖ Check Header Text
        continue-on-error: true
        run: python3 scripts/validate.py check-header-text || echo "check-header-text FAIL" >> result.log

      - name: ‚úÖ Check Header Tag Level
        continue-on-error: true
        run: python3 scripts/validate.py check-header-size || echo "check-header-size FAIL" >> result.log

      - name: ‚úÖ Check Image Name
        continue-on-error: true
        run: python3 scripts/validate.py check-image-name || echo "check-image-name FAIL" >> result.log

      - name: ‚úÖ Check Image Link
        continue-on-error: true
        run: python3 scripts/validate.py check-image-link || echo "check-image-link FAIL" >> result.log

      - name: ‚úÖ Check Image Hash
        continue-on-error: true
        run: python3 scripts/validate.py check-image-hash || echo "check-image-hash FAIL" >> result.log

      - name: ‚ùå Final Merge Gate
        run: |
          if [ -f result.log ]; then
            echo "‚ùå One or more checks failed:"
            cat result.log
            exit 1
          else
            echo "‚úÖ All checks passed."
          fi

      - name: üîí Lock Submissions After Success
        if: success()
        run: |
          echo "üîê Setting WINNER_LOCKED = true"
          gh api \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/environments/production/variables/WINNER_LOCKED \
            -f name='WINNER_LOCKED' \
            -f value='true'
        env:
          GH_TOKEN: ${{ secrets.PAT_FOR_ENV_UPDATE }}
#          GH_TOKEN: ${{ github.token }}
